name: build

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Note, if ubuntu-latest changes to a different release, we will need to
      # swap `focal` below to what that new name is for that release.
      RSPM: "https://packagemanager.rstudio.com/all/__linux__/focal/latest"
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout benchmarks
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
      - name: Lint (black)
        uses: psf/black@stable
        with:
          options: --check --diff
          src: .
      - name: Install Python dependencies
        run: |
          pip install -e '.[dev]'
      - name: Lint (flake8)
        run: |
          flake8
      - name: Lint (isort)
        # Note(JP): if --check fails then it's not always obvious why.
        # Show diff beforehand.
        run: |
          isort --diff .
          isort --check .
      - name: Install libcurl (for R arrow)
        run: |
          sudo apt-get -y install libssl-dev libcurl4-openssl-dev
      - name: Cache R packages
        uses: actions/cache@v2
        id: rlibcache
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('setup.py') }}
      - name: Install R dependencies
        run: |
          # install remotes, arrow (nightly), and arrowbench
          install.packages('remotes')
          install.packages('arrow', repos = c('https://arrow-r-nightly.s3.amazonaws.com', getOption('repos')))
          remotes::install_github('voltrondata-labs/arrowbench')
        shell: Rscript {0}
        env:
          LIBARROW_BINARY: TRUE
      - name: Run tests
        run: |
          coverage run --source benchmarks -m pytest -v --durations=20 benchmarks/tests/
      - name: Publish coverage
        run: |
          coveralls --service=github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
